<%!
from django.utils.translation import ugettext as _
from django.core.urlresolvers import reverse
%>

<%page args="course_overview, enrollment, show_courseware_link, cert_status, can_unenroll, credit_status, show_email_settings, course_mode_info, show_refund_option, is_paid_course, is_course_blocked, verification_status, course_requirements, dashboard_index, user, course_program_info" />


<%
  if is_course_blocked:
    course_target = "#"
    blocked_class = "blocked"
  else:
    course_target = reverse('info', args=[unicode(course_overview.id)])
    blocked_class = ""
  endif
%>

% if settings.FEATURES.get('ENABLE_VERIFIED_CERTIFICATES'):
  <%
      course_verified_certs = enrollment_mode_display(
          enrollment.mode,
          verification_status.get('status'),
          course_overview.id
      )
  %>
  <%
      mode_class = course_verified_certs.get('display_mode', '')
      if mode_class != '':
          mode_class = ' ' + mode_class ;
  %>
% else:
  <% mode_class = '' %>
% endif

<li class="a--dashboard-course-listing-01">
  <article class="a--dashboard-course-listing-01__container ${blocked_class} course${mode_class}">
    <a
      % if show_courseware_link:
        href="${course_target}"
      % endif
      data-course-key="${enrollment.course_id}" class="a--dashboard-course-listing-01__course-image" style="background-image: url('${course_overview.course_image_url}');" alt="${_('{course_number} {course_name} Home Page').format(course_number=course_overview.number, course_name=course_overview.display_name_with_default) |h}">
      % if is_course_blocked:
        <span class="course-blocked-overlay"></span>
        <span class="course-blocked-label">Blocked</span>
      % endif
      % if settings.FEATURES.get('ENABLE_VERIFIED_CERTIFICATES') and course_verified_certs.get('display_mode') != 'audit':
        <div class="certificate-enrollment-label">
          <i class="certificate-icon fa fa-bookmark-o"></i>
          <div>
            <span class="label">${_("Enrolled as: ")}</span>
            <span class="value">${course_verified_certs.get('enrollment_value')}</span>
          </div>
        </div>
      % endif
    </a>
    <div class="a--dashboard-course-listing-01__details-wrapper">
      <div class="a--dashboard-course-listing-01__details-container">
        <!-- course title -->
        % if show_courseware_link:
          <a
            % if not is_course_blocked:
              href="${course_target}"
            % endif
            class="a--dashboard-course-listing-01__course-name">
              ${course_overview.display_name_with_default}
            </a>
        % else:
          <h2 class="a--dashboard-course-listing-01__course-name">
            ${course_overview.display_name_with_default}
          </h2>
        % endif
        <!-- course-organisation -->
        <h4 class="a--dashboard-course-listing-01__course-organisation-id">
          ${course_overview.display_org_with_default | h} - <span>${course_overview.display_number_with_default | h}</span>
        </h4>
        <!-- course dates -->
        <div class="a--dashboard-course-listing-01__course-dates">
          % if course_overview.has_ended():
            <span class="course-ended">${_("Ended - {end_date}").format(end_date=course_overview.end_datetime_text("SHORT_DATE"))}</span>
          % elif course_overview.has_started():
            <span class="course-started">${_("Started - {start_date}").format(start_date=course_overview.start_datetime_text("SHORT_DATE"))}</span>
          % elif course_overview.start_date_is_still_default: # Course start date TBD
            <span class="course-coming-soon">${_("Coming Soon")}</span>
          % elif course_overview.starts_within(days=5):   # hasn't started yet
            <span class="course-starts-soon">${_("Starts - {start_date}").format(start_date=course_overview.start_datetime_text("DAY_AND_TIME"))}</span>
          % else:   # hasn't started yet
            <span class="course-starts">${_("Starts - {start_date}").format(start_date=course_overview.start_datetime_text("SHORT_DATE"))}</span>
          % endif
        </div>
        <!-- course options -->
        <ul class="a--dashboard-course-listing-01__course-options actions-dropdown-list" id="actions-dropdown-list-${dashboard_index}">
          <li class="actions-item" id="actions-item-unenroll-${dashboard_index}">
            % if is_paid_course and show_refund_option:
              % if not is_course_blocked:
                <a href="#unenroll-modal" class="action action-unenroll" rel="leanModal" data-course-id="${course_overview.id | h}" data-course-number="${course_overview.number | h}" data-course-name="${course_overview.display_name_with_default | h}" data-dashboard-index="${dashboard_index}" data-track-info="${_("Are you sure you want to unenroll from the purchased course %(course_name)s (%(course_number)s)?") | h}" data-refund-info="${_("You will be refunded the amount you paid.") | h}">${_('Unenroll')}</a>
              % else:
                <a class="action action-unenroll is-disabled" data-course-id="${course_overview.id | h}" data-course-number="${course_overview.number | h}" data-course-name="${course_overview.display_name_with_default | h}" data-dashboard-index="${dashboard_index}" data-track-info="${_("Are you sure you want to unenroll from the purchased course %(course_name)s (%(course_number)s)?") | h}" data-refund-info="${_("You will be refunded the amount you paid.") | h}">${_('Unenroll')}</a>
              % endif
            % elif is_paid_course and not show_refund_option:
              % if not is_course_blocked:
                <a href="#unenroll-modal" class="action action-unenroll" rel="leanModal" data-course-id="${course_overview.id | h}" data-course-number="${course_overview.number | h}" data-course-name="${course_overview.display_name_with_default | h}" data-dashboard-index="${dashboard_index}" data-track-info="${_("Are you sure you want to unenroll from the purchased course %(course_name)s (%(course_number)s)?") | h}" data-refund-info="${_("You will not be refunded the amount you paid.") | h}">${_('Unenroll')}</a>
              % else:
                <a class="action action-unenroll is-disabled" data-course-id="${course_overview.id | h}" data-course-number="${course_overview.number | h}" data-course-name="${course_overview.display_name_with_default | h}" data-dashboard-index="${dashboard_index}" data-track-info="${_("Are you sure you want to unenroll from the purchased course %(course_name)s (%(course_number)s)?") | h}" data-refund-info="${_("You will not be refunded the amount you paid.") | h}">${_('Unenroll')}</a>
              % endif
            % elif enrollment.mode != "verified":
              % if not is_course_blocked:
                <a href="#unenroll-modal" class="action action-unenroll" rel="leanModal" data-course-id="${course_overview.id | h}" data-course-number="${course_overview.number | h}" data-course-name="${course_overview.display_name_with_default | h}" data-dashboard-index="${dashboard_index}" data-track-info="${_("Are you sure you want to unenroll from %(course_name)s (%(course_number)s)?") | h}">${_('Unenroll')}</a>
              % else:
                <a class="action action-unenroll is-disabled" data-course-id="${course_overview.id | h}" data-course-number="${course_overview.number | h}" data-course-name="${course_overview.display_name_with_default | h}" data-dashboard-index="${dashboard_index}" data-track-info="${_("Are you sure you want to unenroll from %(course_name)s (%(course_number)s)?") | h}">${_('Unenroll')}</a>
              % endif
            % elif show_refund_option:
              % if not is_course_blocked:
                <a href="#unenroll-modal" class="action action-unenroll" rel="leanModal" data-course-id="${course_overview.id | h}" data-course-number="${course_overview.number | h}" data-course-name="${course_overview.display_name_with_default | h}" data-dashboard-index="${dashboard_index}" data-cert-name-long="${cert_name_long | h}" data-track-info="${_("Are you sure you want to unenroll from the verified %(cert_name_long)s track of %(course_name)s (%(course_number)s)?") | h}" data-refund-info="${_("You will be refunded the amount you paid.") | h}">${_('Unenroll')}</a>
              % else:
                <a class="action action-unenroll is-disabled" data-course-id="${course_overview.id | h}" data-course-number="${course_overview.number | h}" data-course-name="${course_overview.display_name_with_default | h}" data-dashboard-index="${dashboard_index}" data-cert-name-long="${cert_name_long | h}" data-track-info="${_("Are you sure you want to unenroll from the verified %(cert_name_long)s track of %(course_name)s (%(course_number)s)?") | h}" data-refund-info="${_("You will be refunded the amount you paid.") | h}">${_('Unenroll')}</a>
              % endif
              % else:
                % if not is_course_blocked:
                  <a href="#unenroll-modal" class="action action-unenroll" rel="leanModal" data-course-id="${course_overview.id | h}" data-course-number="${course_overview.number | h}" data-course-name="${course_overview.display_name_with_default | h}" data-dashboard-index="${dashboard_index}" data-cert-name-long="${cert_name_long | h}" data-track-info="${_("Are you sure you want to unenroll from the verified %(cert_name_long)s track of %(course_name)s (%(course_number)s)?") | h}" data-refund-info="${_("The refund deadline for this course has passed, so you will not receive a refund.") | h}">${_('Unenroll')}</a>
                % else:
                  <a class="action action-unenroll is-disabled" data-course-id="${course_overview.id | h}" data-course-number="${course_overview.number | h}" data-course-name="${course_overview.display_name_with_default | h}" data-dashboard-index="${dashboard_index}" data-cert-name-long="${cert_name_long | h}" data-track-info="${_("Are you sure you want to unenroll from the verified %(cert_name_long)s track of %(course_name)s (%(course_number)s)?") | h}" data-refund-info="${_("The refund deadline for this course has passed, so you will not receive a refund.") | h}">${_('Unenroll')}</a>
                % endif
              % endif
          </li>
          <li class="actions-item" id="actions-item-email-settings-${dashboard_index}">
            % if show_email_settings:
              % if not is_course_blocked:
                <a href="#email-settings-modal" class="action action-email-settings" rel="leanModal" data-course-id="${course_overview.id | h}" data-course-number="${course_overview.number | h}" data-dashboard-index="${dashboard_index}" data-optout="${unicode(course_overview.id) in course_optouts}">${_('Email Settings')}</a>
              % else:
                <a class="action action-email-settings is-disabled" data-course-id="${course_overview.id| h}" data-course-number="${course_overview.number | h}" data-dashboard-index="${dashboard_index}" data-optout="${unicode(course_overview.id) in course_optouts}">${_('Email Settings')}</a>
              % endif
            % endif
          </li>
        </ul>
        <footer class="wrapper-messages-primary">
          <ul class="messages-list">
            % if course_overview.may_certify() and cert_status:
              <%include file='/dashboard/_dashboard_certificate_information.html' args='cert_status=cert_status,course_overview=course_overview, enrollment=enrollment, reverify_link=reverify_link'/>
            % endif

            % if credit_status is not None:
              <%include file="/dashboard/_dashboard_credit_info.html" args="credit_status=credit_status"/>
            % endif

              % if verification_status.get('status') in [VERIFY_STATUS_NEED_TO_VERIFY, VERIFY_STATUS_SUBMITTED, VERIFY_STATUS_APPROVED, VERIFY_STATUS_NEED_TO_REVERIFY] and not is_course_blocked:
              <div class="message message-status wrapper-message-primary is-shown">
                % if verification_status['status'] == VERIFY_STATUS_NEED_TO_VERIFY:
                  <div class="verification-reminder">
                    % if verification_status['days_until_deadline'] is not None:
                      <h4 class="message-title">${_('Verification not yet complete.')}</h4>
                      <p class="message-copy">${ungettext(
                        'You only have {days} day left to verify for this course.',
                        'You only have {days} days left to verify for this course.',
                        verification_status['days_until_deadline']
                      ).format(days=verification_status['days_until_deadline'])}</p>
                    % else:
                      <h4 class="message-title">${_('Almost there!')}</h4>
                      <p class="message-copy">${_('You still need to verify for this course.')}</p>
                    % endif
                  </div>
                  <div class="verification-cta">
                    <a href="${reverse('verify_student_verify_now', kwargs={'course_id': unicode(course_overview.id)})}" class="cta" data-course-id="${course_overview.id}">${_('Verify Now')}</a>
                  </div>
                % elif verification_status['status'] == VERIFY_STATUS_SUBMITTED:
                  <h4 class="message-title">${_('You have already verified your ID!')}</h4>
                  <p class="message-copy">${_('Thanks for your patience as we process your request.')}</p>
                % elif verification_status['status'] == VERIFY_STATUS_APPROVED:
                  <h4 class="message-title">${_('You have already verified your ID!')}</h4>
                  % if verification_status.get('verification_good_until') is not None:
                    <p class="message-copy">${_('Your verification status is good until {date}.').format(date=verification_status['verification_good_until'])}
                  % endif
                % elif verification_status['status'] == VERIFY_STATUS_NEED_TO_REVERIFY:
                  <h4 class="message-title">${_('Your verification will expire soon!')}</h4>
                  ## Translators: start_link and end_link will be replaced with HTML tags;
                  ## please do not translate these.
                  <p class="message-copy">${Text(_('Your current verification will expire before the verification deadline '
                    'for this course. {start_link}Re-verify your identity now{end_link} using a webcam and a '
                    'government-issued ID.')).format(
                      start_link=HTML('<a href="{href}">').format(href=reverse('verify_student_reverify')),
                      end_link=HTML('</a>')
                    )}
                  </p>
                % endif
              </div>
              % endif

              % if course_mode_info['show_upsell'] and not is_course_blocked:
                <div class="message message-upsell has-actions is-shown">

                  <div class="wrapper-extended">
                      <p class="message-copy" align="justify">
                        <b class="message-copy-bold">
                          ${_("Pursue a {cert_name_long} to highlight the knowledge and skills you gain in this course.").format(cert_name_long=cert_name_long)}
                        </b><br>
                          ${Text(_("It's official. It's easily shareable. "
                              "It's a proven motivator to complete the course. {line_break}"
                              "{link_start}Learn more about the verified {cert_name_long}{link_end}.")).format(
                                line_break=HTML('<br>'),
                                link_start=HTML('<a href="{}" class="verified-info" data-course-key="{}">').format(
                                  marketing_link('WHAT_IS_VERIFIED_CERT'),
                                  enrollment.course_id
                                ),
                                link_end=HTML('</a>'),
                                cert_name_long=cert_name_long
                              )}
                      </p>
                      <div class="action-upgrade-container">
                        % if use_ecommerce_payment_flow and course_mode_info['verified_sku']:
                          <a class="action action-upgrade" href="${ecommerce_payment_page}?sku=${course_mode_info['verified_sku']}">
                        % else:
                          <a class="action action-upgrade" href="${reverse('verify_student_upgrade_and_verify', kwargs={'course_id': unicode(course_overview.id)})}" data-course-id="${course_overview.id}" data-user="${user.username}">
                        % endif
                            <span class="action-upgrade-icon" aria-hidden="true"></span>
                          <span class="wrapper-copy">
                            <span class="copy" id="upgrade-to-verified">${_("Upgrade to Verified")}</span>
                              <span class="sr">&nbsp;${_(course_overview.display_name_with_default)}</span>
                          </span>
                        </a>
                      </div>
                  </div>
                </div>
              %endif

              % if course_program_info and course_program_info.get('category')=='xseries':
                %for program_data in course_program_info.get('course_program_list', []):
                  <%include file = "/dashboard/_dashboard_xseries_info.html" args="program_data=program_data, enrollment_mode=enrollment.mode, display_category=course_program_info['display_category']" />
                %endfor
              % endif

              % if is_course_blocked:
                <p id="block-course-msg" class="course-block">
                  ${Text(_("You can no longer access this course because payment has not yet been received. "
                      "You can {contact_link_start}contact the account holder{contact_link_end} "
                      "to request payment, or you can "
                      "{unenroll_link_start}unenroll{unenroll_link_end} "
                      "from this course")).format(
                    contact_link_start=HTML('<a href="#">'),
                    contact_link_end=HTML('</a>'),
                    unenroll_link_start=HTML(
                      '<a id="unregister_block_course" rel="leanModal" '
                      'data-course-id="{course_id}" data-course-number="{course_number}" data-course-name="{course_name}" '
                      'href="#unenroll-modal">'
                    ).format(
                      course_id=course_overview.id,
                      course_number=course_overview.number,
                      course_name=course_overview.display_name_with_default,
                    ),
                    unenroll_link_end=HTML('</a>'),
                  )}
                </p>
              %endif


              % if course_requirements:
              ## Multiple pre-requisite courses are not supported on frontend that's why we are pulling first element
              <% prc_target = reverse('about_course', args=[unicode(course_requirements['courses'][0]['key'])]) %>
              <li class="prerequisites">
                <p class="tip">
                  ${Text(_("You must successfully complete {link_start}{prc_display}{link_end} before you begin this course.")).format(
                      link_start=HTML('<a href="{}">').format(prc_target),
                      link_end=HTML('</a>'),
                      prc_display=course_requirements['courses'][0]['display'],
                    )}
                </p>
              </li>
              % endif
          </ul>
        </footer>
      </div>
    </div>
    <div class="a--dashboard-course-listing-01__courseware-link">
      % if not is_course_blocked:
        <a href="${course_target}"><i class="fa fa-angle-double-right"></i></a>
      % endif
    </div>
  </article>
  <script>
    $( document ).ready(function() {
      if("${is_course_blocked}" == "True"){
        $( "#unregister_block_course" ).click(function() {
          $('.disable-look-unregister').click();
        });
      }
    });
  </script>
</li>
